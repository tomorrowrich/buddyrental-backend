#!/usr/bin/env sh

echo "âœ¨ Formatting code..."
cross-env pnpm format
cross-env pnpm prisma format

echo "ğŸ” Running linter..."
cross-env pnpm lint

# Add already formatted files
git update-index --again

if git diff --name-only --cached | grep -q '^prisma/'; then
  echo "ğŸ” Running pre-commit checks for Prisma..."

  # Use cross-platform path separator
  SCHEMA_PATH="prisma/schema.prisma"

  # Generate Prisma client
  echo "ğŸ“¦ Generating Prisma client..."
  cross-env pnpm prisma generate

  echo "ğŸ“Š Checking for pending Prisma migrations..."
  if ! cross-env pnpm prisma migrate status ; then
    echo "âŒ Error: There are pending Prisma migrations."
    echo "ğŸ‘‰ Please run 'pnpm prisma migrate deploy' to apply pending migrations."
    exit 1
  fi
  echo "âœ… No pending migrations found."

  echo "ğŸ”„ Checking for schema changes..."
  if ! cross-env pnpm prisma migrate diff --from-schema-datamodel "$SCHEMA_PATH" --to-schema-datasource "$SCHEMA_PATH" --exit-code ; then
    echo "âŒ Error: Your schema.prisma has uncommitted changes."
    echo "ğŸ‘‰ Please run 'pnpm prisma migrate dev' to create a new migration."
    exit 1
  fi
  echo "âœ… Schema is up to date."
fi

echo "ğŸƒ Running tests..."
cross-env pnpm test

echo "âœ… All pre-commit checks passed successfully!"
